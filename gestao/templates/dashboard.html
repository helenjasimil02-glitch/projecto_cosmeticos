{% extends 'base.html' %}
{% block page_title %}Painel de Intelig√™ncia{% endblock %}
{% block content %}

<!-- ALERTA DE RISCO (CAPITAL ESTAGNADO) -->
{% if capital_estagnado > 0 %}
<div class="alert border-0 shadow-sm rounded-4 mb-4 d-flex align-items-center justify-content-between" style="background: #fff5f5; border-left: 5px solid #ff4d4d !important;">
    <div><small class="text-danger fw-bold">‚ö†Ô∏è ALERTA: CAPITAL ESTAGNADO</small><p class="mb-0 text-muted small">Dinheiro parado em produtos sem rotatividade: <strong>{{ capital_estagnado|floatformat:2 }} Kz</strong></p></div>
    <i class="bi bi-exclamation-triangle text-danger fs-3"></i>
</div>
{% endif %}

<!-- KPIs FINANCEIROS -->
<div class="row g-3 mb-4">
    <div class="col"><div class="card p-2 border-0 shadow-sm rounded-4 text-center"><small class="text-muted fw-bold" style="font-size:0.6rem;">RECEITAS</small><div class="fw-bold text-success small">{{ entradas|floatformat:0 }} Kz</div></div></div>
    <div class="col"><div class="card p-2 border-0 shadow-sm rounded-4 text-center"><small class="text-muted fw-bold" style="font-size:0.6rem;">CUSTOS</small><div class="fw-bold text-danger small">{{ saidas|floatformat:0 }} Kz</div></div></div>
    <div class="col"><div class="card p-2 border-0 shadow-sm rounded-4 text-center"><small class="text-muted fw-bold" style="font-size:0.6rem;">LUCRO</small><div class="fw-bold {{ status_cor }} small">{{ lucro|floatformat:0 }} Kz</div></div></div>
    <div class="col"><div class="card p-2 border-0 shadow-sm rounded-4 text-center bg-primary text-white"><small class="fw-bold opacity-75" style="font-size:0.6rem;">VALOR STOCK</small><div class="fw-bold small">{{ valor_inventario|floatformat:0 }} Kz</div></div></div>
    <div class="col"><div class="card p-2 border-0 shadow-sm rounded-4 text-center bg-dark text-white"><small class="fw-bold text-warning" style="font-size:0.6rem;">CAPITAL GIRO</small><div class="fw-bold small">{{ capital_giro|floatformat:0 }} Kz</div></div></div>
</div>

<!-- GR√ÅFICO ABC -->
<div class="row g-3">
    <div class="col-md-5">
        <div class="card p-3 border-0 shadow-sm rounded-4 h-100">
            <h6 class="fw-bold small mb-3">Distribui√ß√£o de Capital (ABC) üíé</h6>
            <div style="max-height: 180px;"><canvas id="graficoABC"></canvas></div>
        </div>
    </div>
    <div class="col-md-7">
        <div class="card p-3 border-0 shadow-sm rounded-4 h-100">
            <h6 class="fw-bold small mb-2 text-danger">Reposi√ß√£o Cr√≠tica (Abaixo do M√≠nimo) ‚ö°</h6>
            <table class="table table-sm mb-0" style="font-size: 0.75rem;">
                {% for p in alertas_stock %}
                <tr>
                    <td><strong>{{ p.nome }}</strong> <span class="text-muted">({{ p.marca }})</span></td>
                    <td class="text-end fw-bold text-danger">{{ p.stock_actual }} un.</td>
                </tr>
                {% empty %}
                <tr><td colspan="2" class="text-muted small">Tudo em dia.</td></tr>
                {% endfor %}
            </table>
        </div>
    </div>
</div>

<!-- ALERTAS DE VALIDADE (FEFO) NO FUNDO -->
<div class="row g-3 mt-1">
    <div class="col-12">
        <div class="card p-3 border-0 shadow-sm rounded-4">
            <h6 class="fw-bold small mb-2 text-warning">Validade Pr√≥xima (FEFO) ‚è≥</h6>
            <table class="table table-sm mb-0" style="font-size: 0.75rem;">
                <thead><tr class="text-muted"><th>PRODUTO / MARCA</th><th class="text-center">LOTE</th><th class="text-end">VENCIMENTO</th></tr></thead>
                <tbody>
                    {% for i in alertas_validade %}
                    <tr>
                        <td><strong>{{ i.produto.nome }}</strong> <span class="text-muted">({{ i.produto.marca }})</span></td>
                        <td class="text-center">{{ i.lote }}</td>
                        <td class="text-end fw-bold text-warning">{{ i.validade|date:"d/m/Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center text-muted small">Nenhum lote a vencer em 30 dias.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    new Chart(document.getElementById('graficoABC'), {
        type: 'doughnut',
        data: {
            labels: ['Classe A', 'Classe B', 'Classe C'],
            datasets: [{ data: {{ abc_counts|safe }}, backgroundColor: ['#4b0082', '#d81b60', '#dee2e6'], borderWeight: 0 }]
        },
        options: { cutout: '75%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
    });
</script>
{% endblock %}